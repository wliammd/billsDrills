# **bookdown** Tips for This Document {#bookdownplan}

## Basic conventions 
  * I am deeply indepted to Yihui Xie and his efforts to improve open source publishing via **bookdown**. The basic structure of this book is taken directly from Xie's `bookdown-demo` [@R-bookdown]. 
  * The `_bookdown.yml` file contains a snippet that is important to inserting the word "Chapter" before the chapter number in each of the Rmd files. 
  * `_output.yml` is modified from that used by Xie in his `bookdown-demo` [@R-bookdown]; it evokes `style.css`, `toc.css`, `preamble.tex`, which are also borrowed from Xie. 
  * Packages are indicated in bold, like **dplyr**
  * Programs, like RStudio or MS Word, are in regular typeface
  * Inline code, functions, and file names are indicated in typewriter face using backticks, like `_bookdown.yml`. Functions are generally written with parentheses, like `mean()`. 
  * Chapters are set in order by using adding 01, 02, 03, ... before the name of their Rmd, like `01chpter.Rmd`. Note that they can have short descriptive phrases, since the actual chapter titles are determined by the hashtag. `index.Rmd` always comes first in the book build, and contains the `yml` front matter. 
  * The most frequently used keyboard shortcuts from RStudio include:
    + Option-Hyphen (the assignment operator)
    + Shift-Control-c (comment code hashtag)
    + Option-Command-i (code chunk)
    + Shift-Control-m (pipe)
  
Knitting the document to HTML is generally best, since it's fast and robust during the drafting phase of book writing. PDF construction can is finicky and time-consuming and should be reserved for near the end of the process. When building PDF's with bookdown, the following will prevent source code from running off the page:

```{r}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

## RStudio Tip: Preview in Viewer Pane

Note that RStudio offers a "Preview in Viewer Pane" option, which is vastly faster and more convenient (although smaller) than previewing your beautiful file in a standalone window. When you have the luxery of working with a large monitor, this is the best way to watch your code unfold into an Rmarkdown document. 

## Inserting pictures

Pictures can be included in the `pathologyImages` subdirectory and referenced with a descriptive title in brackets followed by the file path in parentheses, like this: ``![Pithy title. Figure A. Figure B](filepath/image_name.jpg)``

Note that I had to use double backticks around the above code in order to display the "Pithy title" figure reference. 

Here's an example with a real image (code hidden in the final document):

![Tpit immunohistochemical stain. Figure A silent corticotroph. Figure B gonadotroph](pathologyImages/TpitIHC.jpg)

Some of the subdirectories throw an error in building the book, so I settled on `_bookdown_files/pathologyImages` as the location.

Also, note that the build does not generate the caption unless the reference is on it's own line. 

Also note that some controls on image size are available. For instance, the same image can be displayed at 50% size using {} after the reference, as follows:

``![Tpit immunohistochemical stain. Figure A silent corticotroph. Figure B gonadotroph](pathologyImages/TpitIHC.jpg){#id.class width=50% height=50%}``

![Tpit immunohistochemical stain. Figure A silent corticotroph. Figure B gonadotroph](pathologyImages/TpitIHC.jpg){#id.class width=50% height=50%}

## Referencing other parts of the document

Say that I want to refer the reader to a figure. I accomplish this with by inserting a reference with a snippet like this: ``\@ref(fig:example_figure-1)``

Now for a real reference. See Figure \@ref(fig:starfig-1).

I can reference other pages in a similar fashion, for instance, ``\@ref(bookdownplan)``. Note that this works by referencing a `{#label}` placed in the chapter title. 

See Chapter \@ref(intro)
See Chapter \@ref(bookdownplan). 

Note that the `{#label}` uses a single run-together word. It does not tolerate spaces and this cannot be overcome by 'quoting' it. 

## Referencing citations:

In order to insert citations, one needs a `.bib` file in the project. I've included one in this project as `book.bib` and another for packages as `packages.bib`. The yml header in Chapter \@ref(intro) needs to have a $bibliography:$. 

I use EndNote extensively in my writing and research and enjoy the convenience of EndNote in MS Word, so I populate the `book.bib` and `packages.bib` files carefully, usually by adding individual references copied as `BibTex Export` in the EndNote summary interface to the `book.bib` file. 

One can also generate a large number of references in `.txt` files generated in EndNote. For instance, A dump of my EndNote library is in `bookFromEndnote.txt`. This can be opened in RStudio, and I can copy-and-paste references from the `.txt` file to my `book.bib`. 

An example: to cite a pituitary pathology paper that I want to cite here [@RN5748], I'd copy-and-paste the reference from `bookFromEndnote.txt` to `book.bib` or grab the `BibTex Export` from EndNote directly. 

`citr`, a plugin for RStudio, has become somewhat harder to use. When attempting to install the package, a warning is generated that states that "package ‘citr’ is not available for this version of R." A version can still be obtained from GitHub repository, but this is probably more trouble than it's worth, at least in my workflow. 

Of note, Yihui Xie includes a nifty bit of code to automatically generate a `.bib` database for all the R packages that I'd like to cite:

```{r}
knitr::write_bib(c(.packages(), 'bookdown', 'knitr', 'rmarkdown', 'tidyverse', 'caret', 'citr'), 'packages.bib')
```

The citation for a package can also be called with `citation("packagename")`. For instance:

```{r}
citation("tidyverse")
```

All packages are maintained in `packages.bib`. **caret**, for instance, is cited thusly ``[@R-caret]`` [@R-caret]. 

Individual references can be strung together with semicolons [@RN5924; @R-tidyverse]. 

Sometimes references can be buggy. Citing base R [@R-base] alone works, but citing it in a list with other references does not necessarily work [@R-base, @R-caret, @R-tidyverse].

Reference styles are altered by dropping a line in the `yml` header, for example, `csl: american-medical-association.csl`. Some nice details can be found at <https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html>. Different styles can be found at <https://www.zotero.org/styles>.

This page has a nice discussion of citing R packages: <https://www.r-bloggers.com/2021/11/how-to-cite-r-and-r-packages/?utm_source=phpList&utm_medium=email&utm_campaign=R-bloggers-daily&utm_content=HTML>

In the knitted document, references appear automatically at the end of ~~a chapter~~ the document.  

## Figures.   

 **tidyverse** and **gglplot2** are used extensively in this book. The most powerful arguments that can be brought to these analyses are made with graphs and tables. 

```{r loadTidyverse, message=FALSE, warning=FALSE}
library(tidyverse)
```

To generate the following figure, the code chunk contains the following: `{r starfig-1, fig.cap='Starwars Figure 1'}`. This labels the figure with a short name, *starfig-1*, and gives it the caption *Starwars Figure 1*. 

```{r starfig-1, fig.cap='Starwars Figure 1'}
starwars %>% filter(!is.na(species)) %>% 
  mutate(species = fct_lump(species, 5)) %>% 
  mutate(species = species %>% fct_infreq() %>% fct_rev()) %>% 
  ggplot() +
  geom_bar(aes(species, fill = gender)) +
  labs(
    title = "Nifty Starwars Figure",
    x = "Species",
    y = "Count"
  ) +
  coord_flip()
```

## Working with Github

Document control is important. Using the terminal, one can maintain a Github repository for a project. 

Recent changes at require the use of a **personal access token** rather than a password in order to update the repo from the terminal. Instructions can be found at <https://docs.github.com/en/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token>. 

The **personal access token** replaces the password in the Apple keychain. Following the above link explains this, and offers a further link to illustrate the process of changing the keychain. 

## Working with a lot of packages

It it sometimes difficult to keep track of all the packages used in a large bookdown project. A package by Desi Quintans may help: **librarian** may be just the thing that I need. Desi Quintans describes it in this post on CRAN <https://cran.r-project.org/web/packages/librarian/vignettes/intro-to-librarian.html>.

I think that I'll wait a while and see how well **librarian** is supported. Meanwhile, a bit of code can assemble the packages that I use throughout this work, assembled by hand:

```{r}
# Package names
packages <- c("tidyverse", "knitr", "formatR", "bookdown")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
```

